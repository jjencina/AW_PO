<!DOCTYPE html>
<html lang="es">
<head>
    <title>Destinos turísticos</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel='stylesheet' href='/stylesheets/reserva.css' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
    <%- include("header") %>     
    <div class="container compensacion-lateral" id="ctn-carrusel">
        <div class="row">
        <!--La primera columna es el carrusel de imagenes-->
            <div class="col-md-8">
            <div class="container">
                <div id="imagenCarousel" class="carousel slide" data-bs-ride="carousel">
                <!--Las imagenes del carrusel-->
                <div class="carousel-inner">                  
                    <div class="carousel-item active">
                        <img src="/img/<%= imagenes[0].nombre_imagen %>" class="card img-fluid mx-auto" alt="<%=imagenes[0].nombre_imagen%>">
                    </div>
                    <div class="carousel-item">
                        <img src="/img/<%= imagenes[1].nombre_imagen%>" class="card img-fluid mx-auto" alt="<%= imagenes[1].nombre_imagen%>">
                    </div>
                    <div class="carousel-item">
                        <img src="/img/<%= imagenes[2].nombre_imagen%>" class="card img-fluid mx-auto" alt="<%= imagenes[2].nombre_imagen%>">
                    </div>                   
                </div>
                <!--Botones de control del carrusel-->
                <a class="carousel-control-prev" href="#imagenCarousel" role="button" data-bs-slide="prev" style="width: 10%;">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>                
                </a>
                <a class="carousel-control-next" href="#imagenCarousel" role="button" data-bs-slide="next" style="width: 10%;">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>                    
                </a>
                </div>
            </div>
            </div>
            <!--La segunda columna es la descripción del destino-->
            <div class="col-md-4">
            <div class="container" id="descripcionDestino">
                <h5><%= destino.nombre%></h5>
                <a><%= destino.precio %>€</a>
                <p><%= destino.descripcion %></p>
                <!--Botón mostrar-->
                <input type="checkbox" id="mostrarFormulario" class="d-none">
                <label for="mostrarFormulario" class="btn btn-primary">Reserva ya</label>
    
                <!-- Formulario de reserva -->
                <form id="reservaForm" action='/reservar' method="post" class="d-none">
                <!-- Campos ocultos para pasar datos del destino -->
                <input type="hidden" name="nombre" value="<%= destino.nombre %>">
                <input type="hidden" name="id_destino" value="<%= destino.id %>">
                <input type="hidden" name="precio_destino" value="<%= destino.precio %>">
                <input type="hidden" name="destino" value="<%= destino %>">
                
                <!-- Campos existentes -->
                <div class="form-group">
                    <label for="nombre_cliente">Nombre del cliente:</label>
                    <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required autocomplete="nombre_cliente" value="<%= FormData.nombre_cliente || '' %>">
                </div>
                <div class="form-group">
                    <label for="email">Correo electrónico:</label>
                    <input type="email" class="form-control" id="email" name="email" required autocomplete="email" value="<%= FormData.email || '' %>">
                </div>
                <div class="form-group">
                    <label for="fechaReserva">Fecha de reserva:</label>
                    <input type="date" class="form-control" id="fechaReserva" name="fechaReserva" required autocomplete="off" %>">
                </div>
    
                <!-- Extras -->
                <div class="form-group">
                <label for="num_entradas">Número de entradas:</label>
                <input type="number" class="form-control" id="num_entradas" name="num_entradas" required min="1" value="<%= FormData.num_entradas || '' %>">
                </div>
                <div class="form-group">
                    <label for="tamano_maleta">Tamaño de la maleta:</label>
                    <select class="form-control" id="tamano_maleta" name="tamano_maleta" required>
                        <option value="equipaje_mano">Equipaje de mano</option>
                        <option value="maleta_grande">Equipaje de mano y dos vultos 25kg</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="clase_tp">Clase de teletrasporte:</label>
                    <select class="form-control" id="clase_tp" name="clase_tp" required>
                        <option value="economico">Económico</option>
                        <option value="confort">Confort</option>
                        <option value="vip">VIP</option>
                    </select>
                </div>
    
                <!-- Botón "Aceptar" -->
                <button type="submit" class="btn btn-primary">Aceptar</button>
                
                <!-- Mostrar mensaje de éxito -->
                <% if (reservaExitosa) { %>
                <div class="alert alert-success" role="alert">
                    Reserva exitosa. ¡Gracias!
                </div>
                <% } %>
                
                <!-- Mostrar mensajes de error -->
                <% if (errors && errors.length > 0) { %>
                <div class="alert alert-danger" role="alert">
                    <ul>
                    <% errors.forEach(error => { %>
                        <li><%= error.msg %></li>
                    <% }); %>
                    </ul>
                </div>
                <% } %>
    
            </form>
    
            </div>
            </div>
        </div>
        </div>
    <!--TODO
    <div class="container"> 
    
    <h4>Valoración</h4>
    
    </div>-->
    <!--TODO-->
    <div class="container"> 
        <!--Boton ver comentario-->
        <button type="button" class="btn btn-primary" id="botonVer">Ver comentarios</button>

        <div id="cnt-comentarios">
            <h4>Comentarios</h4>
            <form action="/comentar/<%= destino.id %>" method="post" id="comentarios">
                <div id="cnt-coment"><label for="comentario">Comentar como <r><%= usuario || "invitado"%> </r></label></div>    
                <div id="cnt-input">  <textarea id="comentario" name="comentario" rows="4" cols="100" required></textarea></div>
                <button type="submit"  class="btn btn-primary" id="botonComentar">Comentar</button>
            </form>
            
            <ul id="listaComentarios"></ul> 
        
        </div>
    </div>
    <!--Funcionamiento del boton mostrar-->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        var mostrarFormularioBtn = document.getElementById('mostrarFormulario');
        var reservaForm = document.getElementById('reservaForm');
        
        // Verifica el estado del checkbox al cargar la página
        if (mostrarFormularioBtn.checked) {
            reservaForm.classList.remove('d-none');
        } else {
            reservaForm.classList.add('d-none');
        }
        
        mostrarFormularioBtn.addEventListener('change', function () {
            // Mostrar el formulario al marcar el checkbox
            if (mostrarFormularioBtn.checked) {
            reservaForm.classList.remove('d-none');
            } else {
            reservaForm.classList.add('d-none');
            }
        });
        
        // Verifica si hay errores o éxito al cargar la página y muestra el formulario si es necesario
        var errorsExist = document.querySelector('.alert-danger');
        var successExist = document.querySelector('.alert-success');
        
        if (errorsExist || successExist) {
            mostrarFormularioBtn.checked = true;
            reservaForm.classList.remove('d-none');
        }
        });
    </script>
   
    <%- include("footer") %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        
        //Peticion AJAX para insertar comentarios
        function insertarComentarios(){
            $.ajax({
                url: "/comentar/<%= destino.id %>",
                type: "POST",
                data: $("#comentarios").serialize(),
                success: function(){
                   //redirige a la misma pagina para que se actualice la lista de comentarios
                    window.location.href = "/reserva/<%= destino.nombre%>";
                }
            });
        }
        //JQuery para accionar el boton de comentar
        $(function(){$("#botonComentar").click(insertarComentarios);});
        
        let mostrando = false;
        function mostrarComentarios(){
            //La primera parte es para ocultar o mostrar la parte de comentarios
            mostrando = !mostrando;
            if(mostrando){
                $("#cnt-comentarios").show();
                $("#comentario").focus();
                $("#botonVer").html("Ocultar comentarios");      
                $('html, body').animate({scrollTop:500});
                
            }else{
                $("#cnt-comentarios").hide();
                $("#botonVer").html("Ver comentarios");
            }
            //La segunda parte es una peticion AJAX para mostrar los comentarios
            $.ajax({
                url: "/comentar/<%= destino.id %>",
                type: "GET",
                success: function(comentarios){
                    mostrarListaC(comentarios);
                }
            });
        };
        //Funcion para transformar la lista de comentarios de la base de datos en una lista de HTML
        function mostrarListaC(comentarios) {
            const listaComentarios = $("#listaComentarios");
            listaComentarios.empty(); // Limpiar lista antes de agregar comentarios nuevos
            
            comentarios.reverse();
            comentarios.forEach(function(comentario) {
                // Crear elemento de lista para cada comentario
                const divUser = $("<div>").text(`${comentario.nombre_usuario} a las ${comentario.fecha_comentario} comentó:`);
                const divComentario = $("<div>").text(`${comentario.comentario}`);
                divUser.css("color","gray").css("font-size","smaller").css("font-style","italic");
                const divComentarioCompleto = $("<div>").append(divUser,divComentario);
                const li = $("<li>").append(divComentarioCompleto);
                listaComentarios.append(li);
            });
            
            listaComentarios.css( "list-style", "none").css("margin","10px").css("padding","5px");
        }
        //JQuery para accionar el boton de ver comentarios
        $(function(){$("#botonVer").click(mostrarComentarios);});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>
    
   