<!DOCTYPE html>
<html lang="es">
<head>
    <title>Reserva de <%=tipo_ins%></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel='stylesheet' href='/stylesheets/reserva.css' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
    <%- include("header") %>     
    <div class="container compensacion-lateral" id="ctn-carrusel">
        <div class="row">
        <!--La primera columna es el carrusel de imagenes-->
            <div class="col-md-8">
                <div class="container">
                    <div id="imagenCarousel" class="carousel slide" data-bs-ride="carousel">
                    <!--Las imagenes del carrusel-->
                    <div class="carousel-inner">                  
                        <div class="carousel-item active">
                            <img src="/img/<%= imagenes[0].nombre_imagen %>" class="card img-fluid mx-auto" alt="<%=imagenes[0].nombre_imagen%>">
                        </div>                
                    </div>
                    <!--Botones de control del carrusel-->
                    <a class="carousel-control-prev" href="#imagenCarousel" role="button" data-bs-slide="prev" style="width: 10%;">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>                
                    </a>
                    <a class="carousel-control-next" href="#imagenCarousel" role="button" data-bs-slide="next" style="width: 10%;">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>                    
                    </a>
                    </div>
                </div>
            </div>
            <!--La segunda columna es la descripción del destino-->
            <div class="col-md-4">
                <div class="container" id="descripcionInstalacion">
                    <h5 id="tipoIns"><%=tipo_ins%></h5>
                    <!--Primero selecciona la facultad en la que quiere reservar-->
                    <label for="facultades">Facultad:</label>
                    <select id="facultades">
                        <option value="" disabled selected>Selecciona una facultad</option>
                        <option value="Informática">Informática</option>
                        <option value="Biología">Biología</option>
                        <option value="Información">Información</option>
                    </select>
        
                    <!-- Formulario de reserva -->
                    <form id="reservaForm" action='/reservar' method="post" class="d-none">     
                        <input type = "hidden" name = "facultad" id="facultadCampo">             
                        <!-- Campos existentes -->
                        <div class="form-group" id="instalacionCampo">
                            <label for="instalaciones">Instalación</label>
                            <select id="instalaciones">
                            </select>
                        <div class="form-group" id="fechaCampo ">
                            <label for="fecha">Selecciona el día</label>
                            <input type="date" class="form-control" id="fecha" name="fecha" required>
                        </div>

                        <div class="form-group d-none" id="horaCampo" >
                            <label for="hora">Hora</label>
                            <select id="hora">
                             
                            </select>
                        </div>
                        <!-- Botón "Aceptar" -->
                        <button type="submit" class="btn btn-primary">Aceptar</button>
                        
                        <!-- Mostrar mensaje de éxito -->
                        <% if (reservaExitosa) { %>
                        <div class="alert alert-success" role="alert">
                            Reserva exitosa. ¡Gracias!
                        </div>
                        <% } %>                        
                        <!-- Mostrar mensajes de error -->
                        <% if (errors && errors.length > 0) { %>
                        <div class="alert alert-danger" role="alert">
                            <ul>
                            <% errors.forEach(error => { %>
                                <li><%= error.msg %></li>
                            <% }); %>
                            </ul>
                        </div>
                        <% } %>        
                    </form>        
                </div>
            </div>
        </div>
    </div>
    
    <!--Funcionamiento del boton mostrar-->
    <script>
       document.getElementById('facultades').addEventListener('change', function() {
        var facultad = document.getElementById('facultades').value;
            // Mostrar el formulario al marcar el checkbox
            document.getElementById('facultadCampo').value = facultad;
            obtenerInstalaciones(facultad);
            reservaForm.classList.remove('d-none');
        });
        var tipo_ins = $("#tipoIns").text();
        function obtenerInstalaciones(facultad){
            $.ajax({
                url: '/instalaciones',
                type: 'POST',
                data: {facultad: facultad, tipo: tipo_ins},
                success: function(response){
                    let instalaciones = response;
                    let template = '<option value="" disabled selected>Selecciona una instalación</option>';
                    //Obtenemos las instalaciones de la facultad seleccionada con el tipo seleccionado
                    instalaciones.forEach(instalacion => {
                        template += `
                            <option value="${instalacion.nombre}">${instalacion.nombre}</option>
                        `
                    });
                    $('#instalaciones').html(template);
                }
            });
        }

        $("#fecha").change(function(){
            var fecha = $("#fecha").val();
            var facultad = $("#facultadCampo").val();
            var instalacion = $("#instalaciones").val();
            var tipo_ins = $("#tipoIns").text();
            $.ajax({
                url: '/horasDisponibles',
                type: 'POST', 
                data: {fecha: fecha, instalacion: instalacion, tipo_ins:tipo_ins, facultad:facultad},
                success: function(response){
                    let horas = response;
                    if(horas.length == 0){
                        $("#hora").html('<option value="" disabled selected>No hay horas disponibles</option>');
                        return;
                    }
                    let template = '<option value="" disabled selected>Selecciona la hora</option>';
                    horas.forEach(hora => {
                        template += `
                            <option value="${hora}">${hora}</option>
                        `
                    });
                    $('#hora').html(template);
                    $("#horaCampo").removeClass("d-none");
                }
            });
        });
        
        // Verifica si hay errores o éxito al cargar la página y muestra el formulario si es necesario
        var errorsExist = document.querySelector('.alert-danger');
        var successExist = document.querySelector('.alert-success');
        
        if (errorsExist || successExist) {
            reservaForm.classList.remove('d-none');
        };
    </script>
   
    <%- include("footer") %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>
    
   